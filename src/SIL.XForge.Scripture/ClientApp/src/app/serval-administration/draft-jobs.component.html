@if (isOnline) {
  <div class="filter-controls">
    <app-date-range-picker (dateRangeChange)="onDateRangeChange($event)"></app-date-range-picker>
    <div class="export-button-group">
      <button mat-raised-button color="primary" class="export-csv-button" (click)="exportCsv()">
        <mat-icon>download</mat-icon>
        Export CSV
      </button>
      <button mat-raised-button color="primary" class="export-menu-button" [matMenuTriggerFor]="exportMenu">
        <mat-icon>arrow_drop_down</mat-icon>
      </button>
    </div>
    <mat-menu #exportMenu="matMenu" xPosition="before">
      <button mat-menu-item (click)="exportRsv()">
        <mat-icon>download</mat-icon>
        <span>Export RSV</span>
      </button>
    </mat-menu>
    <div class="duration-area">
      <div class="duration-area-stat">
        <span class="duration-area-stat-label"> Mean successful duration </span>
        <span> {{ meanDurationFormatted ?? "n/a" }} </span>
      </div>
      <div class="duration-area-stat">
        <span class="duration-area-stat-label"> Max any duration </span
        ><span> {{ maxDurationFormatted ?? "n/a" }} </span>
      </div>
    </div>
    <div class="grouping-toggle">
      <div class="grouping-toggle-label">
        Determination
        <app-info
          text="Whether to determine build activity more strictly by using request ID where available, or always by using timing."
        ></app-info>
      </div>
      <mat-button-toggle-group [value]="groupingMode" (valueChange)="onGroupingModeChange($event)">
        <mat-button-toggle value="requestId">Request ID</mat-button-toggle>
        <mat-button-toggle value="timing">Timing</mat-button-toggle>
      </mat-button-toggle-group>
    </div>
  </div>

  @if (!isLoading) {
    @if (currentProjectFilter) {
      <app-notice icon="filter_alt" mode="fill-dark">
        <div class="filter-notice-content">
          <span>
            Showing draft jobs for project <strong>{{ filteredProjectName || currentProjectFilter }}</strong>
          </span>
          <button mat-icon-button class="clear-filter-btn" (click)="clearProjectFilter()">
            <mat-icon>clear</mat-icon>
          </button>
        </div>
      </app-notice>
    }

    <div class="table-wrapper">
      <table mat-table id="draft-jobs-table" [dataSource]="rows">
        <tr mat-header-row *matHeaderRowDef="columnsToDisplay"></tr>
        <tr class="job-row" mat-row *matRowDef="let row; columns: columnsToDisplay"></tr>
        <ng-container matColumnDef="status">
          <th mat-header-cell *matHeaderCellDef>Status</th>
          <td mat-cell *matCellDef="let row">
            <div class="status-cell">
              <mat-icon
                class="status-icon"
                [class.successful]="row.job.status === 'success'"
                [class.failed]="row.job.status === 'failed'"
                [class.running]="row.job.status === 'running'"
                [class.cancelled]="row.job.status === 'cancelled'"
                [class.incomplete]="row.job.status === 'incomplete'"
              >
                @if (row.job.status === "success") {
                  check_circle
                } @else if (row.job.status === "failed") {
                  error
                } @else if (row.job.status === "running") {
                  schedule
                } @else if (row.job.status === "cancelled") {
                  cancel
                } @else if (row.job.status === "incomplete") {
                  warning
                }
              </mat-icon>
              <span class="status-label">{{ row.status }}</span>
            </div>
          </td>
        </ng-container>
        <ng-container matColumnDef="projectId">
          <th mat-header-cell *matHeaderCellDef>Project</th>
          <td mat-cell *matCellDef="let row">
            @if (!row.projectDeleted) {
              <a [routerLink]="['/serval-administration', row.projectId]">{{ row.projectName || "Unknown" }}</a>
            } @else {
              <div class="deleted-project">
                <mat-icon class="deleted-project-icon" matTooltip="Project has been deleted">delete</mat-icon>
                <span>{{ row.projectId }}</span>
              </div>
            }
          </td>
        </ng-container>
        <ng-container matColumnDef="trainingBooks">
          <th mat-header-cell *matHeaderCellDef>Training Books</th>
          <td mat-cell *matCellDef="let row">
            @for (projectBook of row.trainingBooks; track projectBook.projectId) {
              <div>
                <a [routerLink]="['/serval-administration', projectBook.projectId]" class="project-link">{{
                  getProjectShortName(projectBook.projectId)
                }}</a
                >:
                @if (projectBook.books.length <= 2) {
                  {{ projectBook.books.join(", ") }}
                } @else {
                  <span [matTooltip]="projectBook.books.join(', ')" class="book-count">
                    {{ projectBook.books.length }} books
                  </span>
                }
              </div>
            } @empty {
              None
            }
          </td>
        </ng-container>
        <ng-container matColumnDef="translationBooks">
          <th mat-header-cell *matHeaderCellDef>Translation Books</th>
          <td mat-cell *matCellDef="let row">
            @for (projectBook of row.translationBooks; track projectBook.projectId) {
              <div>
                <a [routerLink]="['/serval-administration', projectBook.projectId]" class="project-link">{{
                  getProjectShortName(projectBook.projectId)
                }}</a
                >:
                @if (projectBook.books.length <= 2) {
                  {{ projectBook.books.join(", ") }}
                } @else {
                  <span [matTooltip]="projectBook.books.join(', ')" class="book-count">
                    {{ projectBook.books.length }} books
                  </span>
                }
              </div>
            } @empty {
              None
            }
          </td>
        </ng-container>
        <ng-container matColumnDef="startTime">
          <th mat-header-cell *matHeaderCellDef>Start Time</th>
          <td mat-cell *matCellDef="let row">
            {{ row.startTimeStamp }}
          </td>
        </ng-container>
        <ng-container matColumnDef="duration">
          <th mat-header-cell *matHeaderCellDef>Duration</th>
          <td mat-cell *matCellDef="let row">
            @if (row.job.status === "running") {
              <span class="running-text">In progress</span>
            } @else if (row.durationTooltip) {
              <span [matTooltip]="row.durationTooltip">{{ row.duration || "Not available" }}</span>
            } @else {
              {{ row.duration || "Not available" }}
            }
          </td>
        </ng-container>
        <ng-container matColumnDef="author">
          <th mat-header-cell *matHeaderCellDef>Author</th>
          <td mat-cell *matCellDef="let row">
            <app-owner [ownerRef]="row.userId" [includeAvatar]="true"></app-owner>
          </td>
        </ng-container>
        <ng-container matColumnDef="buildDetails">
          <th mat-header-cell *matHeaderCellDef>Build Details</th>
          <td mat-cell *matCellDef="let row">
            <a
              (click)="openJobDetailsDialog(row.job)"
              class="build-id-link"
              [class.disabled]="!row.job.buildId"
              matTooltip="View complete job details including build information and events"
            >
              {{ row.job.buildId || "N/A" }}
            </a>
          </td>
        </ng-container>
      </table>
    </div>

    @if (rows.length === 0) {
      <p id="no-draft-jobs-found-message">No draft jobs found for the selected time period.</p>
    }
  }
} @else {
  <p>You are offline.</p>
}
