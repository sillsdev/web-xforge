<h1>{{ projectName }}</h1>
<a mat-raised-button color="primary" [appRouterLink]="'/serval-administration'">Back to Projects</a>

<h2>Pre-Translation Configuration</h2>
<div class="admin-tool">
  <div class="admin-tool-control">
    <mat-checkbox [checked]="preTranslate" (change)="onUpdatePreTranslate($event.checked)" [disabled]="!isOnline">
      Pre-Translation Drafting Enabled
    </mat-checkbox>
  </div>
  <div class="admin-tool-control">
    <button
      id="run-webhook"
      mat-raised-button
      color="primary"
      (click)="retrievePreTranslationStatus()"
      [disabled]="!isOnline"
    >
      Run webhook to update draft status
    </button>
    <app-info
      text="This will check Serval for any draft pre-translations for this project and update the project's chapters."
    ></app-info>
  </div>
</div>

<h2>Downloads</h2>
<app-notice icon="info">
  The Zip archives contain the Paratext files for the project at the time of last sync.
</app-notice>
<div class="table-container">
  <table mat-table [dataSource]="rows">
    @for (column of columnsToDisplay | slice: 0 : columnsToDisplay.length - 1; track column) {
      <ng-container [matColumnDef]="column">
        <th mat-header-cell *matHeaderCellDef>{{ headingsToDisplay[column] }}</th>
        <td mat-cell *matCellDef="let row">{{ row[column] }}</td>
      </ng-container>
    }

    <ng-container matColumnDef="id">
      <th mat-header-cell *matHeaderCellDef></th>
      <td mat-cell *matCellDef="let row">
        <button
          mat-raised-button
          color="primary"
          (click)="downloadProject(row['id'], row['fileName'])"
          [disabled]="!isOnline"
        >
          Download
        </button>
      </td>
    </ng-container>

    <tr mat-header-row *matHeaderRowDef="columnsToDisplay"></tr>
    <tr mat-row *matRowDef="let myRowData; columns: columnsToDisplay"></tr>
  </table>
</div>

<h2>Last Draft Status</h2>
<div><strong>Build Id:</strong> {{ lastCompletedBuild?.additionalInfo?.buildId }}</div>
<div><strong>Corpora Ids:</strong> {{ lastCompletedBuild?.additionalInfo?.corporaIds?.join(", ") }}</div>
<div><strong>Date Finished:</strong> {{ lastCompletedBuild?.additionalInfo?.dateFinished?.toLocaleString() }}</div>
<div><strong>Message:</strong> {{ lastCompletedBuild?.message }}</div>
<div><strong>Percent Completed:</strong> {{ lastCompletedBuild?.percentCompleted }}</div>
<div><strong>Revision:</strong> {{ lastCompletedBuild?.revision }}</div>
<div><strong>Queue Depth:</strong> {{ lastCompletedBuild?.queueDepth }}</div>
<div><strong>State:</strong> {{ lastCompletedBuild?.state }}</div>
<div><strong>Step:</strong> {{ lastCompletedBuild?.additionalInfo?.step }}</div>
<div><strong>Translation Engine Id:</strong> {{ lastCompletedBuild?.additionalInfo?.translationEngineId }}</div>
<p>
  <button
    (click)="downloadDraft()"
    mat-raised-button
    color="primary"
    [disabled]="!isOnline || lastCompletedBuild == null || downloadBooksTotal > 0"
    id="download-draft"
  >
    Download draft as a zip file
  </button>
  @if (downloadBooksTotal > 0) {
    <span class="zip-progress">Zipping file {{ downloadBooksProgress }} of {{ downloadBooksTotal }}...</span>
  }
</p>

<h2>Last Draft Settings</h2>
<h3>Training books</h3>
<p>{{ trainingBooks.join(", ") || "None" }}</p>
<h3>Training data files</h3>
<p>{{ trainingFiles.join(", ") || "None" }}</p>
<h3>Translation books</h3>
<p>{{ translationBooks.join(", ") || "None" }}</p>

<!-- @if (draftJob$ | async; as draftJob) {
  <app-draft-information [draftJob]="draftJob"></app-draft-information>
} -->
<h2>Raw Draft Configuration</h2>
<pre class="raw-draft-config">
@for (key of keys(draftConfig ?? {}); track key) {
  {{ key }}: <strong>{{ stringify(draftConfig![key]) }}</strong>
}
</pre>
