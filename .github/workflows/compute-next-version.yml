name: "Compute next version"

on:
  workflow_call:
    inputs:
      versioning-system:
        description: "The type of versioning system. Options: production, staging."
        required: true
        type: string
      release-level:
        description: "The level of release, if production. This will bump the major.minor.patch version number accordingly. Options: major, minor, patch. Default: patch."
        required: false
        type: string
        default: "patch"
      tag_prefix:
        description: "The prefix of the VCS tags, such as 'ABCv' or 'DEFv'."
        required: true
        type: string
    outputs:
      next_version:
        description: "The next version number."
        value: ${{ jobs.deploy.outputs.next_version }}

jobs:
  deploy:
    name: "Compute next version"
    runs-on: ubuntu-latest
    outputs:
      next_version: ${{ steps.compute_next_version.outputs.next_version }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: "0"
      - name: Compute next version
        id: compute_next_version
        working-directory: .github/workflows
        run: |
          python3 << EOF
          import os
          import utils

          versioning_system = os.getenv('VERSIONING_SYSTEM')
          release_level = os.getenv('RELEASE_LEVEL')
          tag_prefix = os.getenv('TAG_PREFIX')

          latest_tag = utils.get_latest_tag(tag_prefix)

          if versioning_system == 'production':
            next_version = utils.increment_production_version(latest_tag, release_level, tag_prefix)
          else:
            next_version = utils.increment_staging_version(latest_tag, tag_prefix)

          with open(os.getenv('GITHUB_OUTPUT'), 'a') as file:
            file.write(f'next_version={next_version}')
          EOF
        env:
          VERSIONING_SYSTEM: "${{ inputs.versioning-system }}"
          RELEASE_LEVEL: ${{ github.event.inputs.release-level }}
          TAG_PREFIX: ${{ github.event.inputs.tag_prefix }}
