@if (isLoadingData) {
  <div class="loading-container">
    <mat-spinner></mat-spinner>
  </div>
} @else {
  <div class="requests-container">
    <app-notice type="primary" mode="outline">
      New draft requests start with "New" status and no assignee. Setting an assignee marks a request as "In Progress".
      When a request is marked with one of the resolutions, the assignee will be cleared. Marking a request as resolved
      does not automatically enable drafting on the project.
    </app-notice>

    <p>
      <mat-button-toggle-group [(ngModel)]="activeFilter" class="status-filter">
        @for (option of filterOptions | keyvalue: null; track option.key) {
          <mat-button-toggle [value]="option.key">{{ option.value.name }}</mat-button-toggle>
        }
      </mat-button-toggle-group>
    </p>

    @if (filteredRequests.length === 0) {
      <p class="no-requests">No requests are in the "{{ currentFilterName }}" category.</p>
    } @else {
      <table mat-table [dataSource]="filteredRequests" class="requests-table">
        <!-- Project Column -->
        <ng-container matColumnDef="project">
          <th mat-header-cell *matHeaderCellDef>Project</th>
          <td mat-cell *matCellDef="let request">
            <a [appRouterLink]="['/serval-administration/draft-requests', request.id]">
              {{ getProjectName(request.submission.projectId) }}
            </a>
          </td>
        </ng-container>

        <!-- User Column -->
        <ng-container matColumnDef="user">
          <th mat-header-cell *matHeaderCellDef>User</th>
          <td mat-cell *matCellDef="let request">
            <app-owner
              [ownerRef]="request.submission.userId"
              [dateTime]="request.submission.timestamp"
              [includeAvatar]="true"
            ></app-owner>
          </td>
        </ng-container>

        <!-- Status Column (read-only, calculated from assignee and resolution) -->
        <ng-container matColumnDef="status">
          <th mat-header-cell *matHeaderCellDef>Status</th>
          <td mat-cell *matCellDef="let request">{{ getStatus(request.status).label }}</td>
        </ng-container>

        <!-- Assignee Column -->
        <ng-container matColumnDef="assignee">
          <th mat-header-cell *matHeaderCellDef>Assignee</th>
          <td mat-cell *matCellDef="let request">
            <mat-form-field class="assignee-field" subscriptSizing="dynamic">
              <mat-select [(ngModel)]="request.assigneeId" (selectionChange)="onAssigneeChange(request, $event.value)">
                <mat-option value="">
                  <span style="font-style: italic" class="unassigned-option">Unassigned</span>
                </mat-option>
                @for (userId of getAssignedUserOptions(); track userId) {
                  <mat-option [value]="userId">
                    <app-owner [ownerRef]="userId" [includeAvatar]="true"></app-owner>
                  </mat-option>
                }
              </mat-select>
            </mat-form-field>
          </td>
        </ng-container>

        <!-- Resolution Column -->
        <ng-container matColumnDef="resolution">
          <th mat-header-cell *matHeaderCellDef>Resolution</th>
          <td mat-cell *matCellDef="let request">
            <mat-form-field class="resolution-field" subscriptSizing="dynamic">
              <mat-select
                [ngModel]="request.resolution"
                (selectionChange)="onResolutionChange(request, $event.value)"
                [compareWith]="compareResolutions"
                canSelectNullableOptions
              >
                @for (option of resolutionOptions; track option) {
                  <mat-option [value]="option.key">{{ option.label }}</mat-option>
                }
              </mat-select>
            </mat-form-field>
          </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
        <tr mat-row *matRowDef="let row; columns: displayedColumns"></tr>
      </table>
    }
  </div>
}
