<div
  class="answer-question"
  [ngClass]="{
    'question-read': hasUserRead,
    'question-unread': !hasUserRead,
    'question-answered': currentUserTotalAnswers
  }"
>
  <div class="question">
    <div class="question-text">{{ questionDoc?.data?.text }}</div>
    <div *ngIf="questionDoc?.data?.audioUrl" class="question-audio">
      <app-checking-audio-player [source]="questionDoc?.data?.audioUrl"></app-checking-audio-player>
    </div>
  </div>
  <div *ngIf="!answerFormVisible" class="actions">
    <button
      *ngIf="currentUserTotalAnswers === 0 && canAddAnswer"
      mdc-button
      primary
      (click)="showAnswerForm()"
      id="add-answer"
    >
      Add Answer
    </button>
  </div>
</div>
<div *ngIf="answerFormVisible">
  <form [formGroup]="answerForm" autocomplete="off" id="answer-form">
    <mdc-tab-bar #answerTabs fixed>
      <mdc-tab-scroller>
        <mdc-tab icon="title" label="Answer"></mdc-tab>
        <mdc-tab icon="library_music" label="Record/Upload"></mdc-tab>
        <mdc-tab icon="text_rotation_none" label="Select Text"></mdc-tab>
      </mdc-tab-scroller>
    </mdc-tab-bar>
    <div [fxShow]="answerTabs.activeTabIndex === 0" class="answer-tab answer-text">
      <mdc-form-field>
        <mdc-text-field
          appAutofocus
          label="Your Answer"
          type="text"
          formControlName="answerText"
          outlined
          [value]="activeAnswer?.text"
        ></mdc-text-field>
      </mdc-form-field>
    </div>
    <div [fxShow]="answerTabs.activeTabIndex === 1" class="answer-tab answer-record-upload">
      <app-checking-audio-combined
        [source]="activeAnswer?.audioUrl"
        (update)="processAudio($event)"
      ></app-checking-audio-combined>
    </div>
    <div [fxShow]="answerTabs.activeTabIndex === 2" class="answer-tab answer-select-text">
      <mdc-form-field class="scripture-start" [fxHide.lt-xl]="canShowScriptureInput">
        <mdc-text-field
          label="Start reference"
          type="text"
          formControlName="scriptureStart"
          outlined
          [errorStateMatcher]="startReferenceMatcher"
          id="scripture-start"
          (input)="updateScriptureEndEnabled()"
          (change)="extractScriptureText()"
        >
          <mdc-icon mdcTextFieldIcon trailing clickable (click)="openScriptureChooser(scriptureStart)"
            >expand_more</mdc-icon
          >
        </mdc-text-field>
        <mdc-helper-text validation id="question-scripture-start-helper-text">
          <span *ngIf="scriptureStart.hasError('verseFormat')">e.g. JHN 3:16</span>
          <span *ngIf="scriptureStart.hasError('verseRange')">Must be a verse in the question's book and chapter</span>
          <span *ngIf="answerForm.hasError('startReferenceRequired')">Start reference required</span>
        </mdc-helper-text>
      </mdc-form-field>
      <mdc-form-field class="scripture-end" [fxHide.lt-xl]="canShowScriptureInput">
        <mdc-text-field
          label="End reference"
          type="text"
          formControlName="scriptureEnd"
          outlined
          [errorStateMatcher]="parentAndStartMatcher"
          id="scripture-end"
          (change)="extractScriptureText()"
        >
          <mdc-icon mdcTextFieldIcon trailing clickable (click)="openScriptureChooser(scriptureEnd)"
            >expand_more</mdc-icon
          >
        </mdc-text-field>
        <mdc-helper-text validation>
          <span *ngIf="scriptureEnd.hasError('verseFormat')">e.g. JHN 3:16</span>
          <span *ngIf="scriptureEnd.hasError('verseRange')">Must be inside verse range</span>
          <span *ngIf="answerForm.hasError('verseDifferentBookOrChapter')">Must be the same book and chapter </span>
          <span *ngIf="answerForm.hasError('verseBeforeStart')">Must be after <b>Scripture reference</b></span>
        </mdc-helper-text>
      </mdc-form-field>
      <button
        mdc-icon-button
        fxHide.xl
        [fxShow]="scriptureText.value"
        [fxHide.lt-xl]="!canShowScriptureInput"
        (click)="resetScriptureText()"
        icon="refresh"
        class="try-again"
      ></button>
      <mdc-form-field [fxShow]="scriptureText.value" [fxHide.lt-xl]="!canShowScriptureInput" class="scripture-text">
        <mdc-text-field
          label="Scripture"
          type="text"
          formControlName="scriptureText"
          outlined
          readonly
          (change)="checkScriptureText()"
        ></mdc-text-field>
      </mdc-form-field>
    </div>
    <div *ngIf="answerFormSubmitAttempted && answerText.invalid" class="form-helper-text">
      You need to enter your answer or record your answer before saving
    </div>
    <div
      *ngIf="answerFormSubmitAttempted && hasScriptureReferenceError && answerTabs.activeTabIndex !== 2"
      class="form-helper-text"
    >
      Please enter a valid scripture reference in the select text tab
    </div>
    <div class="form-actions">
      <button mdc-button (click)="hideAnswerForm()" id="cancel-answer">Cancel</button>
      <button mdc-button primary form="answer-form" id="save-answer" (click)="submit()">Save Answer</button>
    </div>
  </form>
</div>
<div class="answers-container">
  <ng-container *ngIf="!answerFormVisible && answers.length > 0 && (currentUserTotalAnswers > 0 || !canAddAnswer)">
    <h3>{{ totalAnswersHeading }}</h3>
    <div class="answer" *ngFor="let answer of answers" [ngClass]="{ 'answer-unread': !hasUserReadAnswer(answer) }">
      <div class="like">
        <mdc-icon class="like-answer" (click)="likeAnswer(answer)">thumb_up</mdc-icon>
        <span class="like-count">{{ answer.likes.length }}</span>
      </div>
      <div class="answer-detail">
        <div *ngIf="answer.text" class="answer-text">{{ answer.text }}</div>
        <div *ngIf="answer.scriptureText" class="answer-scripture">
          <span class="answer-scripture-text">{{ answer.scriptureText }}</span>
          <span class="answer-scripture-verse">{{ scriptureTextVerseRef(answer) }}</span>
        </div>
        <app-checking-audio-player *ngIf="answer.audioUrl" [source]="answer.audioUrl"></app-checking-audio-player>
        <div class="answer-footer">
          <div class="actions">
            <button *ngIf="canEditAnswer(answer)" mdc-button (click)="editAnswer(answer)" class="answer-edit">
              Edit
            </button>
            <button *ngIf="canDeleteAnswer(answer)" mdc-button (click)="deleteAnswer(answer)" class="answer-delete">
              Delete
            </button>
          </div>
          <app-checking-owner
            [ownerRef]="answer.ownerRef"
            [includeAvatar]="true"
            [layoutStacked]="true"
            [dateTime]="answer.dateCreated"
          ></app-checking-owner>
        </div>
        <app-checking-comments
          [project]="project"
          [projectUserConfigDoc]="projectUserConfigDoc"
          [questionDoc]="questionDoc"
          (action)="submitCommentAction($event)"
          [answer]="answer"
        ></app-checking-comments>
      </div>
    </div>
  </ng-container>
</div>
